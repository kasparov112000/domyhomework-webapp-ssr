# nginx configuration for Cloudflare real IP support
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-ingress-ingress-nginx-controller
  namespace: default
data:
  # Enable processing of forwarded headers
  use-forwarded-headers: "true"
  
  # Compute the full X-Forwarded-For header
  compute-full-forwarded-for: "true"
  
  # Use CF-Connecting-IP as the real IP header when behind Cloudflare
  real-ip-header: "CF-Connecting-IP"
  
  # Which header to use for forwarded-for
  forwarded-for-header: "X-Forwarded-For"
  
  # Trust Cloudflare's IP ranges (updated list as of 2023)
  # These are Cloudflare's IPv4 ranges
  set-real-ip-from: |
    173.245.48.0/20
    103.21.244.0/22
    103.22.200.0/22
    103.31.4.0/22
    141.101.64.0/18
    108.162.192.0/18
    190.93.240.0/20
    188.114.96.0/20
    197.234.240.0/22
    198.41.128.0/17
    162.158.0.0/15
    104.16.0.0/13
    104.24.0.0/14
    172.64.0.0/13
    131.0.72.0/22
    10.0.0.0/8
    172.16.0.0/12
    192.168.0.0/16
  
  # Also trust load balancer and internal k8s
  proxy-real-ip-cidr: "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,100.64.0.0/10"
  
  # Use proxy protocol
  use-proxy-protocol: "false"
  
  # Enable real IP module
  enable-real-ip: "true"
  
  # Custom log format to see all headers
  log-format-upstream: '[$time_local] $remote_addr - $remote_user "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" X-Forwarded-For="$http_x_forwarded_for" CF-Connecting-IP="$http_cf_connecting_ip" X-Real-IP="$http_x_real_ip" True-Client-IP="$http_true_client_ip"'